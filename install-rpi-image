#!/bin/sh
#
# Download and install a Raspberry Pi image
#

BOTTLE_PI=192.168.99.11:3110

get_hostname()
{
	model=$(cat /proc/device-tree/model | \
			tr -d '\0\n' | \
			tr 'A-Z' 'a-z' | \
			sed -e 's/^raspberry pi /rpi /' \
				-e 's/ rev / rev/' \
				-e 's/compute module / cm /' \
				-e 's/ model //' \
				-e 's/ /-/g' \
				-e 's/\./d/g')
	serial=$(cat /proc/device-tree/serial-number | tr -d '[\0\n]' | tail -c 4)
	echo "${model}-${serial}"
}

install_image()
{
	echo "--- Installing ${1}"
	if wget -O - "${BOTTLE_PI}/images/${1}" | gunzip -c > /dev/mmcblk0 ; then
		sync
		reboot -f
	fi
}

echo "--- Running installer"

echo "--- Waiting for /dev/mmcblk0"
for i in $(seq 10) ; do
	[ -b /dev/mmcblk0 ] && break
    sleep .5
done

echo "--- Waiting for network device"
for i in $(seq 10) ; do
	[ -e /sys/class/net/eth0 ] && break
	[ -e /sys/class/net/wlan0 ] && break
	sleep .5
done

# Get an IP
dhclient

hostname=$(get_hostname)
echo "--- Checking action for ${hostname}"
action=$(wget -q -O - "${BOTTLE_PI}/hosts/${hostname}/action")
if [ "${action%% *}" = "install" ] ; then
	install_image "${action#install }"
fi

# Run the interactive installer
while true ; do
	cat <<__EOF__

--- Select an image to install:
      1) Groovy - arm64
      2) Groovy - armhf
      3) Focal  - arm64
      4) Focal  - armhf
      5) Bionic - arm64
      6) Bionic - armhf
      7) Xenial - arm64
      8) Xenial - armhf

     10) Core20 - arm64
     11) Core20 - armhf
     12) Core18 - arm64
     13) Core18 - armhf
     14) Core16 - arm64
     15) Core16 - armhf

     20) Raspberry Pi OS Lite - arm64
     21) Raspberry Pi OS Lite - armhf

     90) Run a shell
     91) Enter an image name manually
     92) Update the installer
     99) Reboot

__EOF__

	# shellcheck disable=SC2039
	echo -n "--- Choice: "
	read -r tmp

	case "${tmp}" in
		#
		# Ubuntu Server
		#
		1) image=ubuntu-groovy-arm64 ;;
		2) image=ubuntu-groovy-armhf ;;
		3) image=ubuntu-focal-arm64 ;;
		4) image=ubuntu-focal-armhf ;;
		5) image=ubuntu-bionic-arm64 ;;
		6) image=ubuntu-bionic-armhf ;;
		7) image=ubuntu-xenial-arm64 ;;
		8) image=ubuntu-xenial-armhf ;;

		#
		# Ubuntu Core
		#
		10) image=ubuntu-core20-arm64 ;;
		11) image=ubuntu-core20-armhf ;;
		12) image=ubuntu-core18-arm64 ;;
		13) image=ubuntu-core18-armhf ;;
		14) image=ubuntu-core16-arm64 ;;
		15) image=ubuntu-core16-armhf ;;

		#
		# Raspberry Pi OS
		#
		20) image=raspios-lite-arm64 ;;
		21) image=raspios-lite-armhf ;;

		#
		# Misc options
		#
		90)
			/bin/sh
			continue
			;;
		91)
			# shellcheck disable=SC2039
			echo -n "--- Image name: "
			read -r image
			;;
		92)
			mkdir -p /boot
			if mount /dev/mmcblk0p1 /boot ; then
				wget -O - "${BOTTLE_PI}/images/rpi-installer" | \
					( cd /boot && tar --no-same-owner -xzvf - )
				sync
				umount /boot
			fi
			continue
			;;
		99)
			sync
			reboot -f
			continue
			;;

		#
		# Default
		#
		*)
			continue
			;;
	esac

	install_image "${image}"
done
