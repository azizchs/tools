#!/bin/bash -eu
#
# Unmount a partition of a disk image file
#

MOUNTPOINT=${1}

if ! sudo umount "${MOUNTPOINT}" ; then
	echo "Failed to unmount partition"
	exit 1
fi

rmdir "${MOUNTPOINT}"
echo "Partition unmounted"

DEVICE=${MOUNTPOINT%-part*}
DEVICE=/dev/${DEVICE##*-}
if [ -b "${DEVICE}" ] ; then
	sudo qemu-nbd -d "${DEVICE}"
fi
