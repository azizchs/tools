#!/bin/bash -eu

function out()
{
	local rc=$?

	trap - INT TERM EXIT HUP

	partumount "${TMP_DIR}/boot/firmware" || true
	partumount "${TMP_DIR}" || true

	rm -rf "${TMP_DIR}"
	rm -rf "${INITRD_DIR}"

	if [ "${rc}" -ne 0 ] ; then
		echo "Script failed" >&2
	fi

	exit "${rc}"
}

image=$1

cp "${image}" "${image}.prepd"
image=${image}.prepd

TMP_DIR=$(mktemp -d)
INITRD_DIR=$(mktemp -d)
trap out INT TERM EXIT HUP

# -----------------------------------------------------------------------------
# Mount the image

partmount "${image}" 2 "${TMP_DIR}"
partmount "${image}" 1 "${TMP_DIR}/boot/firmware"

# -----------------------------------------------------------------------------
# Copy collect-rpi-data

# shellcheck disable=SC2230
sudo cp "$(which collect-rpi-data)" "${TMP_DIR}/usr/local/bin/"

# -----------------------------------------------------------------------------
# Create the set-hostname script and service unit file

cat <<EOF | sudo tee "${TMP_DIR}/usr/local/bin/set-hostname" >/dev/null
#!/bin/bash

model=\$(cat /proc/device-tree/model | tr '\0' '\n')
serial=\$(cat /proc/cpuinfo | awk '/^Serial/ { print \$3 }')

hostname=\${model#Raspberry Pi }
hostname=\${hostname/ Rev / rev}
hostname=\${hostname/ Compute Module / cm }
hostname=\${hostname/ Model /}
hostname=\${hostname// /-}
hostname=\${hostname//./d}
hostname=rpi-\${hostname,,}-\${serial: -4}

hostnamectl set-hostname "\${hostname}"
EOF
sudo chmod 755 "${TMP_DIR}/usr/local/bin/set-hostname"

cat <<EOF | \
	sudo tee "${TMP_DIR}/etc/systemd/system/set-hostname.service" >/dev/null
# prepare-rpi-image: Set the hostname

[Unit]
Description=Set the hostname
DefaultDependencies=no
After=dbus.service
Before=network-pre.target
Wants=network-pre.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/local/bin/set-hostname

[Install]
WantedBy=multi-user.target
EOF

# -----------------------------------------------------------------------------
# Create the wifi netplan config file

wifi_ssid=$(pass show local/wifi | grep '^ssid: ')
wifi_ssid=${wifi_ssid#* }

wifi_passphrase=$(pass show local/wifi | grep '^passphrase: ')
wifi_passphrase=${wifi_passphrase#* }

cat <<EOF | \
	sudo tee "${TMP_DIR}/etc/netplan/99-prepare-rpi-image.yaml" >/dev/null
network:
    wifis:
        wlan0:
            dhcp4: true
            optional: true
            access-points:
                "${wifi_ssid}":
                    password: "${wifi_passphrase}"
EOF

# -----------------------------------------------------------------------------
# Modify the kernel commandline

sudo sed -i -e 's, console=[0-9a-zA-Z,]*,,g' \
	 "${TMP_DIR}/boot/firmware/cmdline.txt"

cat <<EOF | sudo tee "${TMP_DIR}/etc/default/flash-kernel" >/dev/null
LINUX_KERNEL_CMDLINE="console=tty1 console=ttyS0,115200"
LINUX_KERNEL_CMDLINE_DEFAULTS=
EOF

# -----------------------------------------------------------------------------
# Modify flash-kernel to support booting an installer kernel/initrd via GPIO

cat <<EOF | \
	sudo tee "${TMP_DIR}/etc/flash-kernel/bootscript/bootscr.rpi.new" \
		 >/dev/null
# Inserted by prepare-rpi-image
if gpio input 4; then
  setenv kernel_img installz
  setenv initrd_img install.img
else
  setenv kernel_img vmlinuz
  setenv initrd_img initrd.img
fi

$(sed -e "s,vmlinuz,\${kernel_img}," -e "s,initrd.img,\${initrd_img}," \
	 "${TMP_DIR}/etc/flash-kernel/bootscript/bootscr.rpi")
EOF
sudo mv "${TMP_DIR}/etc/flash-kernel/bootscript/bootscr.rpi.new" \
	 "${TMP_DIR}/etc/flash-kernel/bootscript/bootscr.rpi"

# Use the original kernel/initrd for the installer
sudo cp "${TMP_DIR}/boot/firmware/vmlinuz" \
	 "${TMP_DIR}/boot/firmware/installz"
sudo cp "${TMP_DIR}/boot/firmware/initrd.img" \
	 "${TMP_DIR}/boot/firmware/install.img"

# Modify the installer initrd
(
	cd "${INITRD_DIR}" || exit

	lz4cat "${TMP_DIR}/boot/firmware/install.img" | cpio -i

    cat <<EOF > init
#!/bin/sh

echo "--- Loading installer initrd ..."

[ -d /dev ] || mkdir -m 0755 /dev
[ -d /root ] || mkdir -m 0700 /root
[ -d /sys ] || mkdir /sys
[ -d /proc ] || mkdir /proc
[ -d /tmp ] || mkdir /tmp
mkdir -p /var/lock
mount -t sysfs -o nodev,noexec,nosuid sysfs /sys
mount -t proc -o nodev,noexec,nosuid proc /proc

mount -t devtmpfs -o nosuid,mode=0755 udev /dev
mkdir /dev/pts
mount -t devpts -o noexec,nosuid,gid=5,mode=0620 devpts /dev/pts || true

/bin/sh
EOF
	chmod 755 init

	find . | cpio -H newc -o | gzip -9 | \
		sudo tee "${TMP_DIR}/boot/firmware/install.img" >/dev/null
)

# -----------------------------------------------------------------------------
# Create the prepare-rpi-image script

cat <<EOF | sudo tee "${TMP_DIR}/usr/local/bin/prepare-rpi-image" >/dev/null
#!/bin/bash

function do_init()
{
	echo "-- Waiting for cloud-init to finish"
	while ! [ -e /var/lib/cloud/instance/boot-finished ] ; do
		sleep 1
	done

	echo "-- Installing and removing packages"
	apt purge -y unattended-upgrades
	apt install -y net-tools

	echo "-- Setting password"
	echo "ubuntu:ubuntu" | chpasswd

	echo "-- Enabling set-hostname.service"
	systemctl enable set-hostname.service

	echo "-- Running flash-kernel"
	flash-kernel

	echo "-- Rebooting"
	reboot
}

do_init 2>&1 | \
	awk '{ print strftime("%Y-%m-%d %H:%M:%S -"), \$0 }' | \
	tee -a /var/log/prepare-rpi-image.log
EOF
sudo chmod 755 "${TMP_DIR}/usr/local/bin/prepare-rpi-image"

# -----------------------------------------------------------------------------
# Create the cloud-config config snippet

cat <<EOF | \
	sudo tee "${TMP_DIR}/etc/cloud/cloud.cfg.d/99-prepare-rpi-image.cfg" \
		 >/dev/null
ssh_authorized_keys: [ $(cat ~/.ssh/id_rsa.pub) ]
ssh_pwauth: true

runcmd:
  - prepare-rpi-image &
EOF
