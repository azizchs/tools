#!/bin/bash -eu

function out()
{
	local rc=$?

	trap - INT TERM EXIT HUP

	if [ "${MOUNTED}" -eq 1 ] ; then
		partumount "${TMP_DIR}"
	fi
	rmdir "${TMP_DIR}"

	if [ "${rc}" -ne 0 ] ; then
		echo "Script failed" >&2
	fi

	exit "${rc}"
}

image=$1

cp "${image}" "${image}.prepd"
image=${image}.prepd

MOUNTED=0
TMP_DIR=$(mktemp -d)
trap out INT TERM EXIT HUP

# -------------------------------------------------------------------------------------
# Mount the image

partmount "${image}" 2 "${TMP_DIR}"
MOUNTED=1

# -------------------------------------------------------------------------------------
# Copy collect-rpi-data

sudo cp "$(which collect-rpi-data)" "${TMP_DIR}/usr/local/bin/"

# -------------------------------------------------------------------------------------
# Create the set-hostname script and service unit file

cat <<EOF | sudo tee "${TMP_DIR}/usr/local/bin/set-hostname" >/dev/null
#!/bin/bash

model=\$(cat /proc/device-tree/model | tr '\0' '\n')
serial=\$(cat /proc/cpuinfo | awk '/^Serial/ { print \$3 }')

hostname=\${model#Raspberry Pi }
hostname=\${hostname/ Rev / rev}
hostname=\${hostname/ Compute Module / cm }
hostname=\${hostname/ Model /}
hostname=\${hostname// /-}
hostname=\${hostname//./d}
hostname=rpi-\${hostname,,}-\${serial: -4}

hostnamectl set-hostname "\${hostname}"
EOF
sudo chmod 755 "${TMP_DIR}/usr/local/bin/set-hostname"

cat <<EOF | sudo tee "${TMP_DIR}/etc/systemd/system/set-hostname.service" >/dev/null
# prepare-rpi-image: Set the hostname

[Unit]
Description=Set the hostname
DefaultDependencies=no
After=dbus.service
Before=network-pre.target
Wants=network-pre.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/local/bin/set-hostname

[Install]
WantedBy=multi-user.target
EOF

# -------------------------------------------------------------------------------------
# Create the wifi netplan config file

wifi_ssid=$(pass show local/wifi | grep '^ssid: ')
wifi_ssid=${wifi_ssid#* }

wifi_passphrase=$(pass show local/wifi | grep '^passphrase: ')
wifi_passphrase=${wifi_passphrase#* }

cat <<EOF | sudo tee "${TMP_DIR}/etc/netplan/99-prepare-rpi-image.yaml" >/dev/null
network:
    wifis:
        wlan0:
            dhcp4: true
            optional: true
            access-points:
                "${wifi_ssid}":
                    password: "${wifi_passphrase}"
EOF

# -------------------------------------------------------------------------------------
# Modify the kernel commandline

sudo sed -i -e 's, console=[0-9a-zA-Z,]*,,g' "${TMP_DIR}/boot/firmware/cmdline.txt"

cat <<EOF | sudo tee "${TMP_DIR}/etc/default/flash-kernel" >/dev/null
LINUX_KERNEL_CMDLINE="console=tty1 console=ttyS0,115200"
LINUX_KERNEL_CMDLINE_DEFAULTS=
EOF

# -------------------------------------------------------------------------------------
# Create the prepare-rpi-image script

cat <<EOF | sudo tee "${TMP_DIR}/usr/local/bin/prepare-rpi-image" >/dev/null
#!/bin/bash

function do_init()
{
	echo "-- Waiting for cloud-init to finish"
	while ! [ -e /var/lib/cloud/instance/boot-finished ] ; do
		sleep 1
	done

	echo "-- Installing and removing packages"
	apt purge -y unattended-upgrades
	apt install -y net-tools

	echo "-- Setting password"
	echo "ubuntu:ubuntu" | chpasswd

	echo "-- Enabling set-hostname.service"
	systemctl enable set-hostname.service

	echo "-- Configuring and running flash-kernel"
	do_flash_kernel

	echo "-- Rebooting"
	reboot
}

do_init 2>&1 | \
	awk '{ print strftime("%Y-%m-%d %H:%M:%S -"), \$0 }' | \
	tee -a /var/log/prepare-rpi-image.log
EOF
sudo chmod 755 "${TMP_DIR}/usr/local/bin/prepare-rpi-image"

# -------------------------------------------------------------------------------------
# Create the cloud-config config snippet

cat <<EOF | sudo tee "${TMP_DIR}/etc/cloud/cloud.cfg.d/99-prepare-rpi-image.cfg" >/dev/null
ssh_authorized_keys: [ $(cat ~/.ssh/id_rsa.pub) ]
ssh_pwauth: true

runcmd:
  - prepare-rpi-image &
EOF

# -------------------------------------------------------------------------------------
# Unmount the image

partumount "${TMP_DIR}"
MOUNTED=0
